---
layout:     post
title:      runtime 学习笔记
subtitle:    "runtime 到底是什么？"
date:       2018-09-20
author:     水水
header-img: img/post-bg-2015.jpg
catalog: true
tags:
    - iOS
    - 基础知识
    - runtime
---

## 想感受 runtime 的力量吗

> 除了面试中我们会经常被问到 `iOS runtime` 相关知识，水水认为作为一个优秀的 iOSer `runtime` 这种底层的基础知识应该是熟知必会的，就像庖丁解牛一样只有熟悉了牛的经络和骨骼屠夫才会熟练完美的解刨牛，我们程序员也是一样的，只有对自己使用的语言充分的了解，才能更好的使用它。

# iOS runtime 学习笔记

## runtime 介绍
正如我们所熟知的 `Objective-C` 是一门动态语言，高级编程语言想要转换成可执行文件需要先便已成为汇编语言再汇编成机器语言（也就是0 1）但是 `Objective-C` 并不能直接被编译为汇编语言需要先转写成纯 `C` 然后再转换成汇编汇编最后转换成机器码，但是我们也知道 `Objective-C` 是一门面向对象的语言而 `C` 语言是一门面向过程的编程语言因此 runtime 也可以理解成是将面向对象的类转变城面向过程的结构体。目前我们开发使用的 `Objective-C` 2.0 采用的是 modern 版本的 `runtime` 其只能运行在 `iOS` 和 `MacOS` 10.5 之后的 64位程序中。


## runtime 消息传递（messaging）

### 什么是消息传递
我们常写的对对象方法调用的过程可以算是一个消息传递，像这样 `[obj meth]` ，编译器会将这个转换成消息发送 `objc_msgSend(obj,meth)` （即 `C` 语言中函数的写法）

### 实现消息传递
首先先复盘一下消息传递的流程
- 首先通过obj（对象）的isa指针找到它的 class ;
- 在 class 的 method list 找 foo ;
- 如果 class 中没到 foo，继续往它的 superclass 中找 ;
- 一旦找到 foo 这个函数，就去执行它的实现IMP 。

看完这个基本流程会发现其中涉及了这么几个东西，对象（object），对象对应的类（class），类中方法（method），那么接下来通过解读这几个东西源码我们似乎应该就可以将消息传递搞懂一大部分了。

```objc
//对象
struct objc_object {
    Class isa  OBJC_ISA_AVAILABILITY;
};
//类
struct objc_class {
    Class isa  OBJC_ISA_AVAILABILITY;
#if !__OBJC2__
    Class super_class                                        OBJC2_UNAVAILABLE;//OC 2.0 中已经没有了
    const char *name                                         OBJC2_UNAVAILABLE;
    long version                                             OBJC2_UNAVAILABLE;
    long info                                                OBJC2_UNAVAILABLE;
    long instance_size                                       OBJC2_UNAVAILABLE;
    struct objc_ivar_list *ivars                             OBJC2_UNAVAILABLE;
    struct objc_method_list **methodLists                    OBJC2_UNAVAILABLE;
    struct objc_cache *cache                                 OBJC2_UNAVAILABLE;
    struct objc_protocol_list *protocols                     OBJC2_UNAVAILABLE;
#endif
} OBJC2_UNAVAILABLE;
//方法列表
struct objc_method_list {
    struct objc_method_list *obsolete                        OBJC2_UNAVAILABLE;
    int method_count                                         OBJC2_UNAVAILABLE;
#ifdef __LP64__
    int space                                                OBJC2_UNAVAILABLE;
#endif
    /* variable length structure */
    struct objc_method method_list[1]                        OBJC2_UNAVAILABLE;
}                                                            OBJC2_UNAVAILABLE;
//方法
struct objc_method {
    SEL method_name                                          OBJC2_UNAVAILABLE;
    char *method_types                                       OBJC2_UNAVAILABLE;
    IMP method_imp                                           OBJC2_UNAVAILABLE;
}
```

## runtime 消息转发

## runtime 应用

## Reference
- `objc_msgSend` 方法定义如下：

```objc
OBJC_EXPORT id objc_msgSend(id self, SEL op,...)
```

- `Class ` 定义如下：

``` objc
typedef struct objc_class *Class; 
```

- [掘金 jackyshan_](https://juejin.im/post/5ac0a6116fb9a028de44d717)